## 4. CodeQL을 이용한 SQL 삽입 취약점 식별 및 방지 실습 

이 실습은 GitHub의 **Code Scanning (CodeQL)** 기능을 활성화하여 저장소의 잠재적인 코 취약점을 찾아보고, 이를 통해 보안 파이프라인을 경험하는 것을 목표로 합니다.

###  필수 전제 조건

1.  2번 모듈에서 만들었던 github-practice-repo에서 실습을 진행합니다.
2.  **테스트 파일 추가:** 저장소에 SQL 삽입 취약성이 있는 간단한 코드를 포함하는 파일 (예: Python, Java, JavaScript 등)을 추가해야 합니다.

---

### 1.  취약한 테스트 코드 추가

GitHub UI를 통해 저장소에 일부러 취약한 코드를 가진 파일을 추가합니다. (예시: Python)

1.  저장소 페이지에서 **'Add file'** > **'Create new file'**을 선택합니다.
<img width="382" height="197" alt="image" src="https://github.com/user-attachments/assets/5c3456cb-6a2e-443d-95e4-335f7a975722" />  
  
2.  파일명: `vulnerable_app.py`
<img width="807" height="572" alt="image" src="https://github.com/user-attachments/assets/38718de3-497a-4f70-a2ab-2c3d78910fe4" />  
  
3.  아래의 취약한 Python 코드를 붙여 넣습니다.

    ```python
    import sqlite3

    def get_user_data(username):
        db = sqlite3.connect('example.db')
        cursor = db.cursor()
        # **취약점:** 입력(username)을 직접 SQL 쿼리에 삽입
        query = "SELECT * FROM users WHERE username = '" + username + "'"
        cursor.execute(query)
        data = cursor.fetchall()
        db.close()
        return data

    get_user_data("test_user") 
    ```
  
4.  커밋 메시지를 작성하고 **'Commit new file'**을 클릭하여 파일을 저장합니다.  
<img width="1369" height="253" alt="image" src="https://github.com/user-attachments/assets/37a88a56-631f-4557-806c-f2f468a9d327" />
<img width="612" height="657" alt="image" src="https://github.com/user-attachments/assets/d2200ef7-7e35-4554-b57d-623f3ca80fca" />  

(커밋 메세지는 자유롭게 작성해주세요)  
  
---

### 2.  CodeQL (코드 검사) 활성화

GitHub의 보안 탭에서 CodeQL을 활성화합니다.

1.  저장소의 상단 탭에서 **'Security'**를 클릭합니다.
<img width="1278" height="479" alt="image" src="https://github.com/user-attachments/assets/069c5969-fa91-4e03-96ad-12d131c2dd37" />  

2.  좌측 사이드바에서 **'Code scanning'**을 선택합니다.  그 다음 초록색 버튼을 클릭합니다.  
<img width="1736" height="547" alt="image" src="https://github.com/user-attachments/assets/804939f6-16c8-43da-92f0-cdb63e153710" />  
  
3.  **'Set up'** 버튼과 'Advance' 클릭합니다.
<img width="1007" height="607" alt="image" src="https://github.com/user-attachments/assets/f1c6d8cd-cb0d-43c4-8786-0580a894cd21" />  


5.  GitHub가 제공하는 기본 **CodeQL 워크플로우 파일 (`.github/workflows/codeql-analysis.yml`)**을 커밋 버튼을 눌러 추가합니다.  
(이 파일은 저장소에 커밋되어 코드가 푸시될 때마다 검사를 실행하도록 설정합니다.)  <br>  
<img width="1915" height="691" alt="image" src="https://github.com/user-attachments/assets/e05fd725-19ac-45ba-9b84-25ad2dc5b5cf" />    
<img width="632" height="663" alt="image" src="https://github.com/user-attachments/assets/cab4c37d-dff3-4e23-ba33-9dcfb982f7cf" />  

      
  
---

### 3.  CodeQL 실행 및 SQL 취약성 식별

워크플로우가 자동으로 실행되어 코드를 검사하고 결과를 확인합니다.

1.  저장소 상단 탭에서 **'Actions'**를 클릭합니다.
<img width="1878" height="372" alt="image" src="https://github.com/user-attachments/assets/85cb81ca-ed76-42d2-990a-012ab3b1631f" />  
 
2.  CodeQL 워크플로우 (`CodeQL`)가 현재 실행 중이거나 이미 완료되었는지 확인합니다. (실행에는 수 분이 소요될 수 있습니다.)  
3.  실행이 완료되면 다시 **'Security'** > **'Code scanning'**으로 이동합니다.
<img width="1860" height="361" alt="image" src="https://github.com/user-attachments/assets/71ea66a9-992d-4914-9581-11b1bfbcf554" />  

4.  Security 탭에서 코드 스캔 결과를 확인합니다.  
<img width="1417" height="602" alt="image" src="https://github.com/user-attachments/assets/8e83f7d9-3c1c-476a-819d-9eeaac83b023" />  
  
지금의 간단한 코드에서는 코드에 아무런 문제가 없다고 나왔습니다. 
  
---  
  
다음 내용은 복잡한 코드에서 CodeQL로 취약성을 파악해보는 예시입니다.   

### 4. 복잡한 소스 코드에서 취약성 감지하기  

1. [https://github.com/pmj-chosim/RockPaperScissorsLizardSpock](https://github.com/microsoft/RockPaperScissorsLizardSpock) 링크에 접속 후 Fork 합니다.  
<img width="1621" height="508" alt="image" src="https://github.com/user-attachments/assets/b4a358da-41ea-496a-ae62-364a8d3d8615" />  
  
2. Create 버튼을 클릭합니다.
<img width="1057" height="748" alt="image" src="https://github.com/user-attachments/assets/961fe4ac-9567-4a50-a56f-dba9708c5bb9" />  

3. Fork가 완료되면 `Security` 섹션을 클릭한 후, `Code Scanning`섹션을 선택합니다. 이후, `Configure Scanning tool` 버튼을 눌러 CodeQL을 활성화시킵니다.  
<img width="1787" height="671" alt="image" src="https://github.com/user-attachments/assets/715f118d-95df-4ae3-94dc-9d4906f0134b" />  

4. `Default` 버튼을 눌러 CodeQL을 활성화합니다.  
<img width="1017" height="492" alt="image" src="https://github.com/user-attachments/assets/5c049e54-ade3-4739-97c8-a5031e456942" />  
  
앞서 Fork한 이 리포지토리에는 CodeQL 검사를 수행할 수 있는 GitHub Actions 코드(yml)`.github/workflows/codeql-analysis.yml`가 이미 포함되어 있습니다.  
그래서 `Advanced`를 통해 codeql 검사를 수행할 수 있는 yml 파일을 자동 생성하지 않고,  
`Default`를 선택해 현재 리포지토리에 있는 yml 코드를 바탕으로 동작할 수 있게 합니다.   
`Default`를 클릭하면 GitHub이 현재 리포지토리에 있는 yml 코드 중 CodeQL 검사를 수행할 수 있는 파일이 있는지 인식하고, 해당 파일을 실행시킵니다.    
<img width="1017" height="492" alt="image" src="https://github.com/user-attachments/assets/11569d76-80a7-45ca-9884-87c06fe385f2" />  
<img width="613" height="798" alt="image" src="https://github.com/user-attachments/assets/7d99a962-39b1-44ba-9197-388d87c97f0e" />  

5. `Actions` 섹션으로 이동해 CodeQL 검사가 수행되는지 확인합니다. 실행되고 있는 파이프라인을 클릭합니다.  
<img width="1196" height="646" alt="image" src="https://github.com/user-attachments/assets/202b2a10-5d9a-4f99-971a-00ebe1f5a95d" />  
  

6. Actions에서 CI/CD 파이프라인 실행이 완료(초록색 체크 버튼 표시)될 때까지 기다립니다.  
<img width="1490" height="781" alt="image" src="https://github.com/user-attachments/assets/d311e0a6-02d6-4e4d-8f29-deadf70537ee" />    
  
7. Security 탭을 클릭해 CodeQL이 파악한 취약한 부분들을 확인합니다.    
<img width="1522" height="715" alt="image" src="https://github.com/user-attachments/assets/d7dbe17b-2f8a-4c59-a087-871ac9718cd4" />  







CodeQL을 사용하여 취약점을 식별하는 기본 원리를 경험했습니다.
